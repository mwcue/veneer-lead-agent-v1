<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SJ Morse Lead Generator</title>
</head>
<body>
  <h1>Lead Generator</h1>

  <label for="segment-select">Choose segments:</label>
  <select id="segment-select" multiple size="6">
    <option value="Architects & Interior Designers (Corporate & Luxury Focus)">Architects & Interior Designers (Corporate & Luxury Focus)</option>
    <option value="Specialty Millwork & Architectural Woodworking Shops">Specialty Millwork & Architectural Woodworking Shops</option>
    <option value="Institutional & End-User Owners (Corporate, Govt, Healthcare, Education)">Institutional & End-User Owners (Corporate, Govt, Healthcare, Education)</option>
    <option value="Luxury Residential, Yacht & Private Aviation Outfitters">Luxury Residential, Yacht & Private Aviation Outfitters</option>
  </select>

  <br><br>
  <button id="generate-button">Generate Leads</button>
  <p id="result-status"></p>
  <a id="download-link" style="display: none;">Download CSV</a>

  <script>
    const API_BASE = "https://lead-generator-820433507470.us-central1.run.app";  // <-- replace this with actual deployed URL

    document.getElementById("generate-button").addEventListener("click", async () => {
      const selectedOptions = Array.from(document.getElementById("segment-select").selectedOptions);
      const segments = selectedOptions.map(opt => opt.value);
      const resultStatus = document.getElementById("result-status");
      const downloadLink = document.getElementById("download-link");

      resultStatus.textContent = "Processing...";
      downloadLink.style.display = "none";

      try {
        const response = await fetch(`${API_BASE}/run-generator`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-api-key": "sjmorse-secret-key"
          },
          body: JSON.stringify({ segments })
        });

        if (!response.ok) throw new Error(await response.text());
        const { job_id } = await response.json();

        // Wait a few seconds to ensure the backend finishes
        await new Promise(res => setTimeout(res, 2000));

        const resultRes = await fetch(`${API_BASE}/results/${job_id}`);
        if (!resultRes.ok) throw new Error(await resultRes.text());
        const blob = await resultRes.blob();
        const fileName = "lead-results.csv";
        const url = URL.createObjectURL(blob);

        downloadLink.href = url;
        downloadLink.download = fileName;
        downloadLink.textContent = `Download: ${fileName}`;
        downloadLink.style.display = "inline";
        resultStatus.textContent = "Download complete.";

      } catch (err) {
        resultStatus.textContent = "An error occurred: " + err.message;
      }
    });
  </script>
</body>
</html>
